> åŸæ–‡: [Your android libraries should not ask for an application context](https://proandroiddev.com/your-android-libraries-should-not-ask-an-application-context-51986cc140d4)  
> ä½œè€…ï¼š[florent champigny@Idean](https://proandroiddev.com/@champigny.florent)  
> Markdown:[åŸæ–‡](https://github.com/iamyours/Translation/blob/master/en/1.Your%20android%20libraries%20should%20not%20ask%20for%20an%20application%20context.md) | [è¯‘æ–‡](https://github.com/iamyours/Translation/blob/master/zh/1.%E4%BD%A0%E7%9A%84Android%E5%BA%93%E6%98%AF%E5%90%A6%E8%BF%98%E5%9C%A8Application%E4%B8%AD%E5%88%9D%E5%A7%8B%E5%8C%96%EF%BC%9F.md)

![](https://miro.medium.com/max/3426/1*OLkHyo2H7KPpTwFs4LhkSA.png)

é€šå¸¸æ¥è¯´ï¼Œå½“æˆ‘ä»¬å¼•å…¥ä¸€ä¸ªç¬¬ä¸‰æ–¹åº“ï¼Œç¬¬ä¸€ä»¶è¦åšçš„äº‹æƒ…æ˜¯åœ¨`Application`ä¸­çš„`onCreate`ä¼ å…¥`context`åˆå§‹åŒ–è¿™ä¸ªåº“ ğŸ˜ã€‚ä½†æ˜¯ä¸ºä»€ä¹ˆåƒä¸€äº›åº“å¦‚`Firebase`ğŸ”¥ï¼Œåˆå§‹åŒ–çš„æ—¶å€™å¹¶ä¸éœ€è¦åœ¨`Application`ä¸­åˆå§‹åŒ–å‘¢ï¼Ÿä»Šå¤©æˆ‘ä»¬å°±æ¥æ¢ç´¢ä¸€ä¸‹è¿™ä¸ªé—®é¢˜ ğŸ§

### Androidåº“çš„åˆå§‹åŒ–
ä¸¾ä¸ªæ —å­ï¼Œæˆ‘ä»¬éœ€è¦åœ¨appä¸­å›½å‘¢ä½¿ç”¨[ARouter](https://github.com/alibaba/ARouter),åœ¨ä½¿ç”¨å‰éœ€è¦åˆå§‹åŒ–ä¼ å…¥`context`ï¼Œå› æ­¤å¦‚æœæ²¡æœ‰`application`æ—¶æˆ‘ä»¬è¦åˆ›å»ºä¸€ä¸ª:
``` kotlin
class MainApplication : Application() {
    override fun onCreate(){
        super.onCreate()
        ARouter.init(mApplication); 
    }
}
```
ç„¶åè¦åœ¨æ¸…å•æ–‡ä»¶ `AndroidManifest.xml` ä¸­å£°æ˜æ‰ä¼šæ‰§è¡Œ :
``` xml
<application
    android:name=".MainApplication"
    ...
```
#### æ›´å¤šåº“æ€ä¹ˆåŠ
ç°åœ¨æƒ³è±¡æˆ‘ä»¬ä½¿ç”¨äº†[ARouter](https://github.com/alibaba/ARouter),[å‹ç›Ÿç»Ÿè®¡](https://developer.umeng.com/docs/119267/detail/118588),[Realm](https://realm.io/),[ToastUtils](https://github.com/getActivity/ToastUtils)ç­‰åº“æ—¶ï¼Œæˆ‘ä»¬çš„applicationå¯èƒ½ä¼šæ˜¯å¦‚ä¸‹å½¢å¼ï¼š 
``` kotlin
class MainApplication : Application() {
    override fun onCreate(){
        super.onCreate()
        ARouter.init(this)
        UMConfigure.init(this,...)
        Realm.init(this)
        ToastUtils.init(this)
    }
}
```
> åœ¨é¡¹ç›®ä¸­ï¼Œ ä»…ä»…ä¸ºäº†åˆå§‹åŒ–ä¸€äº›åº“ï¼Œæˆ‘å°±å¿…é¡»å¾—æ–°å»º`Application`å¹¶ä¸”åœ¨`onCreate`ä¸­è°ƒç”¨å®ƒã€‚ï¼ˆè¯‘è€…:ä¹Ÿè®¸ä½ è®¤ä¸ºè¿™ä¹Ÿæ²¡ä»€ä¹ˆï¼Œä½†æ˜¯å¦‚æœä½ è‡ªå·±åˆ›å»ºäº†å¤šä¸ªåº“éœ€è¦contextæ—¶ï¼Œä½ æ¯æ¬¡å¾—é¢„ç•™ä¸€ä¸ªinitæ–¹æ³•æš´éœ²ç»™è°ƒç”¨è€…ï¼Œä½¿ç”¨æ—¶åˆå¾—åœ¨applicationåˆå§‹åŒ–ã€‚ï¼‰

![Useless](https://miro.medium.com/max/920/1*Tv5tuGfjnq7dYR5OFGQ3Uw.gif)

### æ— éœ€â€œåˆå§‹åŒ–â€çš„åº“
å¦‚æœä½ çš„é¡¹ç›®åŠ å…¥äº†Firebase ğŸ”¥, ä½ ä¼šå‘ç°å®ƒå¹¶æ²¡æœ‰è¦æ±‚åˆå§‹åŒ–, ä½ åªè¦ä½¿ç”¨å®ƒ :  
![](https://miro.medium.com/max/2816/1*o5FgZDQsCIpsebk3ggGpag.png)

è¿™ä¸ªæ•°æ®åº“è®¿é—®æ²¡æœ‰éœ€è¦`context`çš„ä¼ å…¥ï¼Œé€šè¿‡ç¦»çº¿è®¿é—®å­˜å‚¨æœ¬åœ°ã€‚å¯ä»¥çŒœæµ‹å®ƒæœ‰ä¸€ä¸ªæœºåˆ¶è·å–ä¸Šä¸‹æ–‡`application context`ï¼Œè‡ªåŠ¨å®Œæˆåˆå§‹åŒ–ã€‚

#### ContentProvider & Manifest-Merger
[https://developer.android.com/studio/build/manifest-merge](https://developer.android.com/studio/build/manifest-merge)

> ä½ çš„Apkæ–‡ä»¶åªåŒ…å«ä¸€ä¸ªæ¸…å•æ–‡ä»¶`AndroidManifest.xml`ï¼Œä½†æ˜¯ä½ çš„Android Studioé¡¹ç›®å¯èƒ½ä¼šæœ‰å¤šä¸ªæºé›†(main source set),æ„å»ºå˜ä½“(build variants)ï¼Œå¯¼å…¥çš„åº“(imported libraries)æ„æˆã€‚å› æ­¤åœ¨ç¼–è¯‘æ„å»ºappæ—¶ï¼Œgradleæ’ä»¶ä¼šå°†å¤šä¸ª`manifest`æ–‡ä»¶åˆå¹¶åˆ°ä¸€ä¸ªæ¸…å•æ–‡ä»¶ä¸­å»ã€‚  

æˆ‘ä»¬å¯ä»¥çœ‹ä¸‹åˆå¹¶åçš„æ¸…å•æ–‡ä»¶ï¼ˆç›®å½•å¦‚ä¸‹ï¼‰:  

> app/build/intermediates/merged_manifests/MY_APP/processMY_APPDebugManifest/merged/AndroidManifest.xml

æˆ‘ä»¬å¯ä»¥å‘ç°ä¸€ä¸ªå…³äº`Firebase`åº“çš„`provider`è¢«å¼•å…¥åˆ°æ¸…å•æ–‡ä»¶ä¸­ï¼š   
![](https://miro.medium.com/max/3196/1*p0_tM6nve95xg_T-VfRogQ.png)

ä½¿ç”¨Android Studioç‚¹å‡»æ‰“å¼€`FirebaseInitProvider`, æˆ‘ä»¬çŸ¥é“äº†è¿™ä¸ª`provider`é€šè¿‡`this.getContext()`æ¥è®¿é—®ä¸Šä¸‹æ–‡ã€‚  
å†…å®¹æä¾›è€…`ContentsProviders`ä¼šç›´æ¥åœ¨`Applicationåˆ›å»ºå`å®Œæˆåˆå§‹åŒ–ï¼Œå› æ­¤é€šè¿‡å®ƒæ¥å®Œæˆlibraryçš„åˆå§‹åŒ–ä¸å¤±ä¸ºä¸€ä¸ªå¥½åŠæ³•ã€‚ 
![](https://miro.medium.com/max/3912/1*SYKn4jBiiFhiN5SzdkenGw.png)

### è‡ªåŠ¨åˆå§‹åŒ–æˆ‘ä»¬çš„åº“
å¦‚æœæˆ‘ä»¬è‡ªå®šä¹‰äº†`ToastUtils`åº“éœ€è¦åˆå§‹åŒ–ï¼Œæˆ‘ä»¬è‡ªå·±æä¾›ä¸€ä¸ª`Provider` :
``` kotlin
class ToastInitProvider : ContentProvider() {

    override fun onCreate(): Boolean {
        ToastUtils.init(context)
        return true
    }
    ...
}
```
ç„¶åè¿™ä¸ªåº“ä¸­çš„`AndroidManifest.xml`ä¸­åŠ å…¥å®ƒ
``` xml
<provider
    android:name=".ToastInitProvider"
    android:authorities="xxx.xx.ToastInitProvider" />
```

ç„¶åå½“æˆ‘ä»¬ä½¿ç”¨è¿™ä¸ª`ToastUtils`åº“æ—¶ï¼Œæ— éœ€æ·»åŠ é¢å¤–çš„ä»£ç åœ¨é¡¹ç›®ä¸­åˆå§‹åŒ–å®ƒğŸ˜ï¼Œç›´æ¥ä½¿ç”¨å®ƒå³å¯ï¼š
``` kotlin
ToastUtils.show("this is toast")
```

``` kotlin
Stetho.getInstance().configure(â€¦)
```

### åˆ é™¤Application
å¦‚æœä¸€äº›åº“æ²¡æœ‰ä½¿ç”¨`InitProviders`ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºå®ƒï¼š
``` kotlin
class ARouterInitProvider : ContentProvider() {

    override fun onCreate(): Boolean {
        ARouter.init(this)
        return true
    }
    ...
}
class RealmInitProvider : ContentProvider() {

    override fun onCreate(): Boolean {
        Realm.init(this)
        return true
    }
    ...
}
```
ç„¶ååŠ å…¥åˆ°æ¸…å•æ–‡ä»¶`AndroidManifest`ä¸­ :
``` xml
<provider
    android:name=".ARouterInitProvider"
    android:authorities="${applicationId}.ARouterInitProvider" />
<provider
    android:name=".RealmInitProvider"
    android:authorities="${applicationId}.RealmInitProvider" />
```
ç°åœ¨æˆ‘ä»¬å¯ä»¥ `ç§»é™¤` è¿™ä¸ª `MainApplication`  

![Happy Dance](https://miro.medium.com/max/500/1*5lVoGX22SPqF8AnZpWvV8Q.gif)

### é¡¹ç›®åœ°å€

[https://github.com/florent37/ApplicationProvider](https://github.com/florent37/ApplicationProvider)


